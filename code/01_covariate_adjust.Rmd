---
title: "A study of changes in short chain fatty acids (SCFA) in women during pregnancy whose children developed asthma"
subtitle: "With covariate adjustment"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document: 
    toc: true
    theme: united
---

```{r setup, warning=FALSE, message=FALSE}
# rm(list = ls())
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, 
                      message = FALSE, comment = NA,
                      fig.width = 6.25, fig.height = 5)
options(qwraps2_markup = "markdown",
        qwraps2_frmt_digits = 2)

library(openxlsx)
library(tidyverse) 
library(vegan)
library(CLME)
library(magrittr)
library(qwraps2)
library(ggprism)
library(ggsci)
library(ggpubr)
library(rstatix)
library(jtools)
library(cocor)
```

```{r helper}
plot_box = function(data, group_lab, group_var, key_var, adjust_var, title, y.position, step.increase) {
  
  select_vars = function() {
    any_of(c(group_var, key_var, adjust_var))
  }
  df_fig = data %>%
    dplyr::select(select_vars()) %>%
    mutate(group = get(group_var), value = get(key_var))
  
  bxp = ggboxplot(df_fig, x = "group", y = "value", color = "group",
                  add = "jitter", xlab = FALSE, ylab = FALSE, title = title) +
    scale_color_npg(name = str_to_title(group_var)) +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          strip.background = element_rect(fill = "white"),
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5))
  
  if (!is.null(adjust_var)) {
    lm_formula = paste("value ~ group + ", paste(adjust_var, collapse = " + "))
    lm_fit = lm(as.formula(lm_formula), data = df_fig)
    df_p = data.frame(group1 = "No", group2 = "Yes",
                      p = summary(lm_fit)$coef[grepl("group", names(coef(lm_fit))), "Pr(>|t|)"]) %>%
      mutate(p = round(p, 2))
    
    bxp = bxp + 
      stat_pvalue_manual(df_p, y.position = y.position, 
                         step.increase = step.increase, label = "p")
  } else {
    bxp = bxp + 
      stat_compare_means(method = "wilcox.test", label.x = 1.5, label = "p.format")
  }
  return(bxp)
}

plot_clme = function(clme_obj, group, y_min, y_max, p_gap, fill_lab = "Wheezing", ...) {
  p_val = clme_obj$p.value
  est_mean = clme_obj$theta[group]
  est_se = sqrt(diag(clme_obj$cov.theta))[group]
  
  df_fig = data.frame(x = group, y = est_mean, err = est_se)
  
  if (max(est_mean) >= min(est_mean)) {
    df_p = data.frame(group1 = group[seq_len(length(group) - 1)],
                      group2 = group[-1],
                      x = group[-1],
                      label = paste0("p = ", round(p_val, 3)),
                      y.position = seq.int(from = est_mean[2] + p_gap, 
                                           to = ifelse(est_mean[2] < max(est_mean), 
                                                       max(est_mean) + p_gap, 
                                                       max(est_mean) + 2 * p_gap), 
                                           length.out = length(group) - 1))
  } else {
    df_p = data.frame(group1 = group[seq_len(length(group) - 1)],
                      group2 = group[-1],
                      x = group[-1],
                      label = paste0("p = ", round(p_val, 3)),
                      y.position = seq.int(from = ifelse(est_mean[1] > min(est_mean), 
                                                         est_mean[1] + p_gap, 
                                                         est_mean[1] + 2 * p_gap),
                                           to = min(est_mean) + p_gap, 
                                           length.out = length(group) - 1))
  }
  
  
  fig = df_fig %>%
    ggplot(aes(x = x, y = y)) +
    geom_bar(stat = "identity", color = "black", aes(fill = x)) + 
    geom_errorbar(aes(ymin = y - 1.96 * err, ymax = y + 1.96 * err), 
                  width = .2, position = position_dodge(.9)) +
    add_pvalue(df_p,
               xmin = "group1",
               xmax = "group2",
               label = "label",
               y.position = "y.position",
               remove.bracket = FALSE, 
               ...) +
    ylim(y_min, y_max) +
    theme_bw() +
    scale_fill_npg(name = fill_lab) +
    theme(panel.border = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.line = element_line(size = 0.5),
          plot.title = element_text(hjust = 0.5))
  return(fig)
}

fisher_z = function(data, var1, var2, group) {
   select_vars = function() {
    any_of(c(var1, var2, group))
  }
  df = data %>%
    dplyr::select(select_vars()) %>%
    mutate(var1 = get(var1), 
           var2 = get(var2),
           group = get(group))
  group_level = sort(unique(df$group))
  
  # Create two vectors of data
  x1 = df %>%
    filter(group == group_level[1]) %>%
    dplyr::select(var1) %>%
    .$var1
  y1 = df %>%
    filter(group == group_level[1]) %>%
    dplyr::select(var2) %>%
    .$var2
  x2 = df %>%
    filter(group == group_level[2]) %>%
    dplyr::select(var1) %>%
    .$var1
  y2 = df %>%
    filter(group == group_level[2]) %>%
    dplyr::select(var2) %>%
    .$var2
  
  # Calculate Pearson correlation coefficients
  r1 = cor(x1, y1)
  r2 = cor(x2, y2)
  
  # Convert correlation coefficients to z-scores using Fisher's z-transformation
  z1 = atanh(r1)
  z2 = atanh(r2)
  
  # Calculate the difference between the two z-scores
  z_diff = z1 - z2
  
  # Calculate the standard error of the difference between the two z-scores
  se_z_diff = sqrt((1/(length(x1) - 3)) + (1/(length(x2) - 3)))
  
  # Calculate the test statistic
  test_statistic = z_diff / se_z_diff
  
  # Calculate the p-value
  p_value = 2 * min(pnorm(abs(test_statistic)), 
                    pnorm(abs(test_statistic), lower.tail = FALSE))
  return(p_value)
}
```

# 1. Import data 

```{r}
df_meta = read.xlsx("../data/eager_scfa_samples_matched.xlsx")
df_meta$visit = recode(df_meta$visit, R = "20wks", S = "28wks")
df_meta$wheezing = recode(df_meta$wheezing, `0` = "No", `1` = "Yes")
df_meta$wheezing = factor(df_meta$wheezing)
df_meta$education = factor(df_meta$education,
                           levels = c("Not High-school graduate",
                                      "High-school graduate",
                                      "> High School"))
df_meta$income = factor(df_meta$income)
df_meta$sex_fetus1 = factor(df_meta$sex_fetus1)

df_scfa_raw = read.xlsx("../data/Short-Chain Fatty Acid Analysis Result_Creative Proteomics_CPLC05192202-2.xlsx")

df_loq = df_scfa_raw[3:9, 13:14]
colnames(df_loq) = c("SCFA", "LOQ")

df_scfa_na = df_scfa_raw[-1, 1:12]
colnames(df_scfa_na) = c("Sample", "Barcode1", "Barcode2", "Box_Id", "Sample_Type",
                         "Acetic", "Propionic", "Isobutyric", "Butyric",
                         "Isovaleric", "Valeric", "Hexanoic")
df_scfa_na = df_scfa_na %>%
  mutate_at(vars(Acetic:Hexanoic), as.numeric)
df_merge_na = df_meta %>%
  dplyr::left_join(df_scfa_na, by = c("Barcode1", "Barcode2", "Box_Id"))

df_scfa = df_scfa_na %>%
  replace_na(list(Acetic = df_loq$LOQ[1]/2,
                  Propionic = df_loq$LOQ[2]/2,
                  Isobutyric = df_loq$LOQ[3]/2,
                  Butyric = df_loq$LOQ[4]/2,
                  Isovaleric = df_loq$LOQ[5]/2,
                  Valeric = df_loq$LOQ[6]/2)) %>%
  dplyr::mutate(total = rowSums(across(Acetic:Valeric)))
df_merge = df_meta %>%
  dplyr::left_join(df_scfa, by = c("Barcode1", "Barcode2", "Box_Id"))
df_v1 = df_merge %>%
  filter(visit == "20wks")
df_v2 = df_merge %>%
  filter(visit == "28wks")
df_no = df_merge %>%
  filter(wheezing == "No")
df_yes = df_merge %>%
  filter(wheezing == "Yes")
```

# 2. Descriptive statistics {.tabset}

## Presence/absecence

1. Hexanoic is not available except one sample. Thus, it will be removed from the downstream analysis

2. For the remaining SCFAs, the missing value will be replaced by half of its corresponding LOQ

```{r, results='asis'}
summary_template1 =
  list("Acetic" =
         list("Above LOQ" = ~ n_perc0(!is.na(Acetic)),
              "Below LOQ" = ~ n_perc0(is.na(Acetic))),
       "Propionic" =
         list("Above LOQ" = ~ n_perc0(!is.na(Propionic)),
              "Below LOQ" = ~ n_perc0(is.na(Propionic))),
       "Isobutyric" =
         list("Above LOQ" = ~ n_perc0(!is.na(Isobutyric)),
              "Below LOQ" = ~ n_perc0(is.na(Isobutyric))),
       "Butyric" =
         list("Above LOQ" = ~ n_perc0(!is.na(Butyric)),
              "Below LOQ" = ~ n_perc0(is.na(Butyric))),
       "Isovaleric" =
         list("Above LOQ" = ~ n_perc0(!is.na(Isovaleric)),
              "Below LOQ" = ~ n_perc0(is.na(Isovaleric))),
       "Valeric" =
         list("Above LOQ" = ~ n_perc0(!is.na(Valeric)),
              "Below LOQ" = ~ n_perc0(is.na(Valeric))),
       "Hexanoic" =
         list("Above LOQ" = ~ n_perc0(!is.na(Hexanoic)),
              "Below LOQ" = ~ n_perc0(is.na(Hexanoic)))
       )

df_summ1 = df_merge_na %>%
  summary_table(summary_template1)
df_summ2 = df_merge_na %>%
  group_by(visit) %>%
  summary_table(summary_template1)
cbind(df_summ2, df_summ1)
```

## Table 1

```{r}
summary_template2 =
  list("Any report of asthma or wheezing since birth" =
       list("No" = ~ n_perc0(wheezing == "No", na_rm = TRUE),
            "Yes" = ~ n_perc0(wheezing == "Yes", na_rm = TRUE),
            "NA" = ~ n_perc0(is.na(wheezing))),
       "BMI" =
         list("min" = ~ round(min(BMI, na.rm = T), 2),
              "max" = ~ round(max(BMI, na.rm = T), 2),
              "mean (sd)" = ~ qwraps2::mean_sd(BMI, na_rm = T, show_n = "never")),
       "Age" =
         list("min" = ~ round(min(age, na.rm = T), 2),
              "max" = ~ round(max(age, na.rm = T), 2),
              "mean (sd)" = ~ qwraps2::mean_sd(BMI, na_rm = T, show_n = "never")),
       "Income" =
       list("Annual Less than $19,999" = ~ n_perc0(income == "1", na_rm = TRUE),
            "$20,000-$39,999" = ~ n_perc0(income == "2", na_rm = TRUE),
            "$40,000-$74,999" = ~ n_perc0(income == "3", na_rm = TRUE),
            "$75,000-$99,999" = ~ n_perc0(income == "4", na_rm = TRUE),
            "$100,000" = ~ n_perc0(income == "5", na_rm = TRUE),
            "NA" = ~ n_perc0(is.na(income))),
       "Fetus sex" =
       list("Female" = ~ n_perc0(sex_fetus1 == "2", na_rm = TRUE),
            "Male" = ~ n_perc0(sex_fetus1 == "1", na_rm = TRUE),
            "NA" = ~ n_perc0(is.na(sex_fetus1))),
       "Education" =
       list("Not High-school graduate" = ~ n_perc0(education == "Not High-school graduate", na_rm = TRUE),
            "High-school graduate" = ~ n_perc0(education == "High-school graduate", na_rm = TRUE),
            "> High School" = ~ n_perc0(education == "> High School", na_rm = TRUE),
            "NA" = ~ n_perc0(is.na(education))),
       "Acetic" =
         list("min" = ~ round(min(Acetic, na.rm = T), 2),
              "max" = ~ round(max(Acetic, na.rm = T), 2),
              "mean (sd)" = ~ qwraps2::mean_sd(Acetic, na_rm = T, show_n = "never")),
       "Propionic" =
         list("min" = ~ round(min(Propionic, na.rm = T), 2),
              "max" = ~ round(max(Propionic, na.rm = T), 2),
              "mean (sd)" = ~ qwraps2::mean_sd(Propionic, na_rm = T, show_n = "never")),
       "Isobutyric" =
         list("min" = ~ round(min(Isobutyric, na.rm = T), 2),
              "max" = ~ round(max(Isobutyric, na.rm = T), 2),
              "mean (sd)" = ~ qwraps2::mean_sd(Isobutyric, na_rm = T, show_n = "never")),
       "Butyric" =
         list("min" = ~ round(min(Butyric, na.rm = T), 2),
              "max" = ~ round(max(Butyric, na.rm = T), 2),
              "mean (sd)" = ~ qwraps2::mean_sd(Butyric, na_rm = T, show_n = "never")),
       "Isovaleric" =
         list("min" = ~ round(min(Isovaleric, na.rm = T), 2),
              "max" = ~ round(max(Isovaleric, na.rm = T), 2),
              "mean (sd)" = ~ qwraps2::mean_sd(Isovaleric, na_rm = T, show_n = "never")),
       "Valeric" =
         list("min" = ~ round(min(Valeric, na.rm = T), 2),
              "max" = ~ round(max(Valeric, na.rm = T), 2),
              "mean (sd)" = ~ qwraps2::mean_sd(Valeric, na_rm = T, show_n = "never"))
       )
```

### Total

```{r, results='asis'}
df_summ1 = df_merge %>%
  summary_table(summary_template2)
df_summ2 = df_merge %>%
  group_by(wheezing) %>%
  summary_table(summary_template2)
cbind(df_summ2, df_summ1)
```

### At 20 weeks

```{r, results='asis'}
df_summ1 = df_v1 %>%
  summary_table(summary_template2)
df_summ2 = df_v1 %>%
  group_by(wheezing) %>%
  summary_table(summary_template2)
cbind(df_summ2, df_summ1)
```

### At 28 weeks

```{r, results='asis'}
df_summ1 = df_v2 %>%
  summary_table(summary_template2)
df_summ2 = df_v2 %>%
  group_by(wheezing) %>%
  summary_table(summary_template2)
cbind(df_summ2, df_summ1)
```

## Total SCFA concentrations by groups

### At 20 weeks

```{r}
lm_fit = lm(total ~ wheezing + BMI + age + income + sex_fetus1 + education, data = df_v1)
df_p = data.frame(group1 = "No", group2 = "Yes", y.position = 6,
                  p = summary(lm_fit)$coef[2, "Pr(>|t|)"]) %>%
  mutate(p_lab = paste0("p = ", round(p, 2)))

p_total = ggviolin(df_v1, x = "wheezing", y = "total", color = "wheezing",
                   add = "boxplot", xlab = "Wheezing", ylab = "Total SCFAs") +
  stat_pvalue_manual(df_p, label = "p_lab", remove.bracket = TRUE, hjust = 3) +
  scale_color_npg(name = NULL)
p_total
ggsave("../results/figures/main_violine_total_v1.jpeg", width = 6.25, height = 5, dpi = 100)
ggsave("../results/figures/main_violine_total_v1.pdf", width = 6.25, height = 5)
```

### At 28 weeks

```{r}
lm_fit = lm(total ~ wheezing + BMI + age + income + sex_fetus1 + education, data = df_v2)
df_p = data.frame(group1 = "No", group2 = "Yes", y.position = 6,
                  p = summary(lm_fit)$coef[2, "Pr(>|t|)"]) %>%
  mutate(p_lab = paste0("p = ", round(p, 2)))

p_total = ggviolin(df_v2, x = "wheezing", y = "total", color = "wheezing",
                   add = "boxplot", xlab = "Wheezing", ylab = "Total SCFAs") +
  stat_pvalue_manual(df_p, label = "p_lab", remove.bracket = TRUE, hjust = 3) +
  scale_color_npg(name = NULL)
p_total
ggsave("../results/figures/main_violine_total_v2.jpeg", width = 6.25, height = 5, dpi = 100)
ggsave("../results/figures/main_violine_total_v2.pdf", width = 6.25, height = 5)
```

## SCFA change over time (28 weeks - 20 weeks)

```{r, fig.width=10, fig.height=6}
df_pair = df_v1 %>%
  dplyr::select(Study_ID, Acetic:Valeric, BMI, age, income, sex_fetus1, education) %>%
  dplyr::inner_join(
    df_v2 %>%
      dplyr::select(Study_ID, Acetic:Valeric),
    suffix = c("_v1", "_v2"),
    by = "Study_ID"
  ) %>%
  dplyr::mutate(across(ends_with("_v2"),
                       ~ . - get(str_replace(cur_column(), "_v2$", "_v1")),
                       .names = "diff_{str_replace(.col, '_v2$', '')}")) %>%
  dplyr::left_join(df_v1 %>%
                     dplyr::select(Study_ID, wheezing),
                   by = "Study_ID")

var_list = c("Acetic", "Propionic", "Isobutyric", 
             "Butyric", "Isovaleric", "Valeric")
title_list = c("Acetic Acid", "Propionic Acid", "Isobutyric Acid", 
               "Butyric Acid", "Isovaleric Acid", "Valeric Acid")
y_pos_list = c(3.6, 0.3, 0.04, 0.2, 0.05, 0.02)
step_list = c(0.1, 0.1, 0.1, 0.1, 0.01, 0.005)

bxp_list = list()
for (i in seq_along(var_list)) {
  var = paste0("diff_", var_list[[i]])
  title = title_list[[i]]
  df = df_pair %>%
    dplyr::transmute(value = get(var), group = wheezing,
                     BMI, age, income, sex_fetus1, education)
  lm_fit = lm(value ~ group + BMI + age + income + sex_fetus1 + education, data = df)
  df_p = data.frame(group1 = "No", group2 = "Yes", y.position = y_pos_list[i],
                    p = summary(lm_fit)$coef[2, "Pr(>|t|)"]) %>%
    mutate(p_lab = paste0("p = ", round(p, 2)))
  
  bxp = df %>%
    ggboxplot(x = "group", y = "value", color = "group",
              add = "jitter", xlab = FALSE, ylab = FALSE, title = title) +
    stat_pvalue_manual(df_p, label = "p_lab", remove.bracket = TRUE, hjust = 1.5) +
    scale_color_npg(name = "Wheezing") +
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          strip.background = element_rect(fill = "white"),
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5))
    
  bxp_list[[i]] = bxp
}

p_box = ggarrange(bxp_list[[1]], bxp_list[[2]], bxp_list[[3]], 
                  bxp_list[[4]], bxp_list[[5]], bxp_list[[6]], 
                  ncol = 3, nrow = 2, 
                  common.legend = TRUE, legend = "bottom")
p_box
ggsave("../results/figures/main_box_plot_time_change.jpeg", width = 10, height = 6, dpi = 100)
ggsave("../results/figures/main_box_plot_time_change.pdf", width = 10, height = 6)
```

## Alpha diversities

```{r}
shannon_index = diversity(df_merge %>%
                            dplyr::select(Acetic:Valeric))
df_shannon = df_merge %>%
  dplyr::select(Study_ID, wheezing, visit, BMI, age, income, sex_fetus1, education) %>%
  dplyr::mutate(shannon_index = shannon_index)
df_shannon_v1 = df_shannon %>%
  dplyr::filter(visit == "20wks")
df_shannon_v2 = df_shannon %>%
  dplyr::filter(visit == "28wks")

lm_fit1 = lm(shannon_index ~ wheezing + BMI + age + income + sex_fetus1 + education, 
             data = df_shannon_v1)
lm_fit2 = lm(shannon_index ~ wheezing + BMI + age + income + sex_fetus1 + education, 
             data = df_shannon_v2)
df_p = data.frame(group1 = "No", group2 = "Yes", y.position = 1.5,
                  p = c(summary(lm_fit1)$coef[2, "Pr(>|t|)"],
                        summary(lm_fit2)$coef[2, "Pr(>|t|)"]),
                  visit = c("20wks", "28wks")) %>%
  mutate(p_lab = paste0("p = ", round(p, 2)))

p_box_alpha = df_shannon %>% 
  ggboxplot(x = "wheezing", y = "shannon_index", color = "wheezing", 
            facet.by = "visit", xlab = "Wheezing", ylab = "Shannon Index",
            add = "jitter") +
  stat_pvalue_manual(df_p, label = "p_lab", remove.bracket = TRUE, hjust = 1.5) +
  scale_color_npg(name = NULL)

p_box_alpha
ggsave("../results/figures/main_box_plot_alpha.jpeg", width = 6.25, height = 5, dpi = 100)
ggsave("../results/figures/main_box_plot_alpha.pdf", width = 6.25, height = 5)
```

# 3. Two-group comparisons

1. SCFAs by the outcome variable (any report of asthma or wheezing since birth).

2. P-values were determined by two-sided Wilcoxon rank sum test.

3. Subfigure a: at 20 weeks, subfigure b: at 28 weeks.

```{r, fig.width=14, fig.height=10}
var_list = c("Acetic", "Propionic", "Isobutyric", 
             "Butyric", "Isovaleric", "Valeric")
title_list = c("Acetic Acid", "Propionic Acid", "Isobutyric Acid", 
               "Butyric Acid", "Isovaleric Acid", "Valeric Acid")
y_pos_list = c(6, 0.5, 0.1, 0.25, 0.09, 0.015)
step_list = c(0.1, 0.1, 0.1, 0.1, 0.01, 0.005)

bxp_list_v1 = list()
for (i in seq_along(var_list)) {
  bxp = plot_box(data = df_v1,
                 group_var = "wheezing",
                 key_var = var_list[i], 
                 adjust_var = c("BMI", "age", "income", "sex_fetus1", "education"),
                 title = title_list[i],
                 y.position = y_pos_list[i], 
                 step.increase = step_list[i])
  bxp_list_v1[[i]] = bxp
}

bxp_list_v2 = list()
for (i in seq_along(var_list)) {
  bxp = plot_box(data = df_v2,
                 group_var = "wheezing",
                 key_var = var_list[i], 
                 adjust_var = c("BMI", "age", "income", "sex_fetus1", "education"),
                 title = title_list[i],
                 y.position = y_pos_list[i], 
                 step.increase = step_list[i])
  bxp_list_v2[[i]] = bxp
}

p_box = ggarrange(bxp_list_v1[[1]], bxp_list_v1[[2]], bxp_list_v1[[3]], 
                  bxp_list_v1[[4]], bxp_list_v1[[5]], bxp_list_v1[[6]], 
                  bxp_list_v2[[1]], bxp_list_v2[[2]], bxp_list_v2[[3]], 
                  bxp_list_v2[[4]], bxp_list_v2[[5]], bxp_list_v2[[6]], 
                  ncol = 6, nrow = 2, 
                  labels = c("a", "", "", "", "", "", 
                             "b", "", "", "", "", ""), 
                  common.legend = TRUE, legend = "bottom")
p_box
ggsave("../results/figures/main_box_plot.jpeg", width = 12, height = 10, dpi = 100)
ggsave("../results/figures/main_box_plot.pdf", width = 12, height = 10)
```

# 4. Trend test

1. SCFAs by the outcome variable (any report of asthma or wheezing since birth).

2. P_values were determined by CLME.

```{r}
df_merge$wheezing = factor(df_merge$wheezing, ordered = TRUE,
                           levels = c("No", "Yes"))
```

## 4.1 At 20 weeks {.tabset}

### Monotonic increasing trend

```{r, fig.width=12, cache=TRUE}
cons = list(order = "simple", decreasing = FALSE, node = 1)

fit1 = clme(Acetic ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v1, constraints = cons, seed = 123)
fit2 = clme(Propionic ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v1, constraints = cons, seed = 123)
fit3 = clme(Isobutyric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v1, constraints = cons, seed = 123)
fit4 = clme(Butyric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v1, constraints = cons, seed = 123)
fit5 = clme(Isovaleric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v1, constraints = cons, seed = 123)
fit6 = clme(Valeric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v1, constraints = cons, seed = 123)

summ_fit1 = summary(fit1)
summ_fit2 = summary(fit2)
summ_fit3 = summary(fit3)
summ_fit4 = summary(fit4)
summ_fit5 = summary(fit5)
summ_fit6 = summary(fit6)

fig1 = plot_clme(summ_fit1, group = c("No", "Yes"), 
                 y_min = 0, y_max = 4.5, p_gap = 1.2) +
  labs(x = NULL, y = "Concentration", title = "Acetic Acid")
fig2 = plot_clme(summ_fit2, group = c("No", "Yes"), 
                 y_min = -0.2, y_max = 0.5, p_gap = 0.3) +
  labs(x = NULL, y = "Concentration", title = "Propionic Acid")
fig3 = plot_clme(summ_fit3, group = c("No", "Yes"), 
                 y_min = -0.2, y_max = 0.4, p_gap = 0.25) +
  labs(x = NULL, y = "Concentration", title = "Isobutyric Acid")
fig4 = plot_clme(summ_fit4, group = c("No", "Yes"), 
                 y_min = 0, y_max = 0.35, p_gap = 0.15) +
  labs(x = NULL, y = "Concentration", title = "Butyric Acid")
fig5 = plot_clme(summ_fit5, group = c("No", "Yes"),
                 y_min = 0, y_max = 0.12, p_gap = 0.05) +
  labs(x = NULL, y = "Concentration", title = "Isovaleric Acid")
fig6 = plot_clme(summ_fit6, group = c("No", "Yes"), 
                 y_min = -0.01, y_max = 0.02, p_gap = 0.01) +
  labs(x = NULL, y = "Concentration", title = "Valeric Acid")

p_clme1 = ggarrange(fig1, fig2, fig3, fig4, fig5, fig6, 
                    ncol = 6, common.legend = TRUE, legend = "bottom")
p_clme1
ggsave("../results/figures/main_clme_plot_v1_increase.jpeg", width = 12, height = 5, dpi = 100)
ggsave("../results/figures/main_clme_plot_v1_increase.pdf", width = 12, height = 5)
```

### Monotonic decreasing trend

```{r, fig.width=12, cache=TRUE}
cons = list(order = "simple", decreasing = TRUE, node = 1)

fit1 = clme(Acetic ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v1, constraints = cons, seed = 123)
fit2 = clme(Propionic ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v1, constraints = cons, seed = 123)
fit3 = clme(Isobutyric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v1, constraints = cons, seed = 123)
fit4 = clme(Butyric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v1, constraints = cons, seed = 123)
fit5 = clme(Isovaleric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v1, constraints = cons, seed = 123)
fit6 = clme(Valeric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v1, constraints = cons, seed = 123)

summ_fit1 = summary(fit1)
summ_fit2 = summary(fit2)
summ_fit3 = summary(fit3)
summ_fit4 = summary(fit4)
summ_fit5 = summary(fit5)
summ_fit6 = summary(fit6)

fig1 = plot_clme(summ_fit1, group = c("No", "Yes"), 
                 y_min = 0, y_max = 4.5, p_gap = 1.2) +
  labs(x = NULL, y = "Concentration", title = "Acetic Acid")
fig2 = plot_clme(summ_fit2, group = c("No", "Yes"), 
                 y_min = -0.2, y_max = 0.5, p_gap = 0.3) +
  labs(x = NULL, y = "Concentration", title = "Propionic Acid")
fig3 = plot_clme(summ_fit3, group = c("No", "Yes"), 
                 y_min = -0.2, y_max = 0.4, p_gap = 0.3) +
  labs(x = NULL, y = "Concentration", title = "Isobutyric Acid")
fig4 = plot_clme(summ_fit4, group = c("No", "Yes"), 
                 y_min = 0, y_max = 0.35, p_gap = 0.15) +
  labs(x = NULL, y = "Concentration", title = "Butyric Acid")
fig5 = plot_clme(summ_fit5, group = c("No", "Yes"),
                 y_min = 0, y_max = 0.12, p_gap = 0.05) +
  labs(x = NULL, y = "Concentration", title = "Isovaleric Acid")
fig6 = plot_clme(summ_fit6, group = c("No", "Yes"), 
                 y_min = -0.01, y_max = 0.02, p_gap = 0.01) +
  labs(x = NULL, y = "Concentration", title = "Valeric Acid")

p_clme2 = ggarrange(fig1, fig2, fig3, fig4, fig5, fig6, 
                    ncol = 6, common.legend = TRUE, legend = "bottom")
p_clme2
ggsave("../results/figures/main_clme_plot_v1_decrease.jpeg", width = 12, height = 5, dpi = 100)
ggsave("../results/figures/main_clme_plot_v1_decrease.pdf", width = 12, height = 5)
```

## 4.2 At 28 weeks {.tabset}

### Monotonic increasing trend

```{r, fig.width=12, cache=TRUE}
cons = list(order = "simple", decreasing = FALSE, node = 1)

fit1 = clme(Acetic ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v2, constraints = cons, seed = 123)
fit2 = clme(Propionic ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v2, constraints = cons, seed = 123)
fit3 = clme(Isobutyric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v2, constraints = cons, seed = 123)
fit4 = clme(Butyric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v2, constraints = cons, seed = 123)
fit5 = clme(Isovaleric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v2, constraints = cons, seed = 123)
fit6 = clme(Valeric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v2, constraints = cons, seed = 123)

summ_fit1 = summary(fit1)
summ_fit2 = summary(fit2)
summ_fit3 = summary(fit3)
summ_fit4 = summary(fit4)
summ_fit5 = summary(fit5)
summ_fit6 = summary(fit6)

fig1 = plot_clme(summ_fit1, group = c("No", "Yes"), 
                 y_min = 0, y_max = 4.5, p_gap = 1.2) +
  labs(x = NULL, y = "Concentration", title = "Acetic Acid")
fig2 = plot_clme(summ_fit2, group = c("No", "Yes"), 
                 y_min = -0.1, y_max = 0.6, p_gap = 0.3) +
  labs(x = NULL, y = "Concentration", title = "Propionic Acid")
fig3 = plot_clme(summ_fit3, group = c("No", "Yes"), 
                 y_min = 0, y_max = 0.05, p_gap = 0.02) +
  labs(x = NULL, y = "Concentration", title = "Isobutyric Acid")
fig4 = plot_clme(summ_fit4, group = c("No", "Yes"), 
                 y_min = 0, y_max = 0.35, p_gap = 0.15) +
  labs(x = NULL, y = "Concentration", title = "Butyric Acid")
fig5 = plot_clme(summ_fit5, group = c("No", "Yes"),
                 y_min = 0, y_max = 0.08, p_gap = 0.03) +
  labs(x = NULL, y = "Concentration", title = "Isovaleric Acid")
fig6 = plot_clme(summ_fit6, group = c("No", "Yes"), 
                 y_min = 0, y_max = 0.02, p_gap = 0.01) +
  labs(x = NULL, y = "Concentration", title = "Valeric Acid")

p_clme1 = ggarrange(fig1, fig2, fig3, fig4, fig5, fig6, 
                    ncol = 6, common.legend = TRUE, legend = "bottom")
p_clme1
ggsave("../results/figures/main_clme_plot_v2_increase.jpeg", width = 12, height = 5, dpi = 100)
ggsave("../results/figures/main_clme_plot_v2_increase.pdf", width = 12, height = 5)
```

### Monotonic decreasing trend

```{r, fig.width=12, cache=TRUE}
cons = list(order = "simple", decreasing = TRUE, node = 1)

fit1 = clme(Acetic ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v2, constraints = cons, seed = 123)
fit2 = clme(Propionic ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v2, constraints = cons, seed = 123)
fit3 = clme(Isobutyric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v2, constraints = cons, seed = 123)
fit4 = clme(Butyric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v2, constraints = cons, seed = 123)
fit5 = clme(Isovaleric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v2, constraints = cons, seed = 123)
fit6 = clme(Valeric ~ wheezing + BMI + age + income + sex_fetus1 + education, 
            data = df_v2, constraints = cons, seed = 123)

summ_fit1 = summary(fit1)
summ_fit2 = summary(fit2)
summ_fit3 = summary(fit3)
summ_fit4 = summary(fit4)
summ_fit5 = summary(fit5)
summ_fit6 = summary(fit6)

fig1 = plot_clme(summ_fit1, group = c("No", "Yes"), 
                 y_min = 0, y_max = 4.5, p_gap = 1.4) +
  labs(x = NULL, y = "Concentration", title = "Acetic Acid")
fig2 = plot_clme(summ_fit2, group = c("No", "Yes"), 
                 y_min = -0.1, y_max = 0.55, p_gap = 0.3) +
  labs(x = NULL, y = "Concentration", title = "Propionic Acid")
fig3 = plot_clme(summ_fit3, group = c("No", "Yes"), 
                 y_min = 0, y_max = 0.05, p_gap = 0.02) +
  labs(x = NULL, y = "Concentration", title = "Isobutyric Acid")
fig4 = plot_clme(summ_fit4, group = c("No", "Yes"), 
                 y_min = 0, y_max = 0.35, p_gap = 0.15) +
  labs(x = NULL, y = "Concentration", title = "Butyric Acid")
fig5 = plot_clme(summ_fit5, group = c("No", "Yes"),
                 y_min = 0, y_max = 0.08, p_gap = 0.03) +
  labs(x = NULL, y = "Concentration", title = "Isovaleric Acid")
fig6 = plot_clme(summ_fit6, group = c("No", "Yes"), 
                 y_min = 0, y_max = 0.02, p_gap = 0.01) +
  labs(x = NULL, y = "Concentration", title = "Valeric Acid")

p_clme2 = ggarrange(fig1, fig2, fig3, fig4, fig5, fig6, 
                    ncol = 6, common.legend = TRUE, legend = "bottom")
p_clme2
ggsave("../results/figures/main_clme_plot_v2_decrease.jpeg", width = 12, height = 5, dpi = 100)
ggsave("../results/figures/main_clme_plot_v2_decrease.pdf", width = 12, height = 5)
```

# 5. Correlations 

1. SCFAs correlations by the outcome variable (any report of asthma or wheezing since birth).

2. Fisher's z test was used to determine whether two Pearson correlation coefficients are the same or not between groups at the same time point. 

3. Steigerâ€™s z test was used to determine whether two Pearson correlation coefficients are the same or not between time points within the same group.

## Individual correlations {.tabset}

### Correlations

```{r}
scfa_list = c("Acetic", "Propionic", "Isobutyric", 
              "Butyric","Isovaleric", "Valeric")
df_scfa_v1 = df_v1 %>%
  dplyr::select(wheezing, any_of(scfa_list))
df_scfa_v2 = df_v2 %>%
  dplyr::select(wheezing, any_of(scfa_list))

# Visit 1, No
corr_v1_no = cor(df_scfa_v1 %>%
                   filter(wheezing == "No") %>%
                   dplyr::select(-wheezing)) 
corr_v1_no[is.na(corr_v1_no)] = 0
df_corr_v1_no = as.data.frame(corr_v1_no) %>%
  rownames_to_column("var1") %>%
  pivot_longer(cols = -var1, names_to = "var2", values_to = "value")

# Visit 1, Yes
corr_v1_yes = cor(df_scfa_v1 %>%
                    filter(wheezing == "Yes") %>%
                    dplyr::select(-wheezing)) 
corr_v1_yes[is.na(corr_v1_yes)] = 0
df_corr_v1_yes = as.data.frame(corr_v1_yes) %>%
  rownames_to_column("var1") %>%
  pivot_longer(cols = -var1, names_to = "var2", values_to = "value")

# Visit 2, No
corr_v2_no = cor(df_scfa_v2 %>%
                   filter(wheezing == "No") %>%
                   dplyr::select(-wheezing)) 
corr_v2_no[is.na(corr_v2_no)] = 0
df_corr_v2_no = as.data.frame(corr_v2_no) %>%
  rownames_to_column("var1") %>%
  pivot_longer(cols = -var1, names_to = "var2", values_to = "value")

# Visit 2, Yes
corr_v2_yes = cor(df_scfa_v2 %>%
                    filter(wheezing == "Yes") %>%
                    dplyr::select(-wheezing)) 
corr_v2_yes[is.na(corr_v2_yes)] = 0
df_corr_v2_yes = as.data.frame(corr_v2_yes) %>%
  rownames_to_column("var1") %>%
  pivot_longer(cols = -var1, names_to = "var2", values_to = "value")
```

### p-values

```{r}
scfa_len = length(scfa_list)

# No vs. Yes at visit 1
df_v1_list = list(no = df_v1 %>%
                    filter(wheezing == "No"),
                  yes = df_v1 %>%
                    filter(wheezing == "Yes"))

mat_p_v1 = matrix(NA, nrow = scfa_len, ncol = scfa_len)
colnames(mat_p_v1) = scfa_list
rownames(mat_p_v1) = scfa_list

for (i in seq_len(scfa_len - 1)) {
  for (j in seq(i + 1, scfa_len)) {
    scfa1 = scfa_list[i]
    scfa2 = scfa_list[j]
    co_form = as.formula(paste0("~", scfa1, "+", scfa2, "|", scfa1, "+", scfa2))
    res_indep = cocor(formula = co_form, data = df_v1_list)
    mat_p_v1[i, j] = res_indep@fisher1925$p.value
  }
}

diag(mat_p_v1) = 1
mat_p_v1[lower.tri(mat_p_v1)] = t(mat_p_v1)[lower.tri(mat_p_v1)]
df_p_v1 = as.data.frame(mat_p_v1) %>%
  rownames_to_column("var1") %>%
  pivot_longer(cols = -var1, names_to = "var2", values_to = "pvalue")

# No vs. Yes at visit 2
df_v2_list = list(no = df_v2 %>%
                    filter(wheezing == "No"),
                  yes = df_v2 %>%
                    filter(wheezing == "Yes"))

mat_p_v2 = matrix(NA, nrow = scfa_len, ncol = scfa_len)
colnames(mat_p_v2) = scfa_list
rownames(mat_p_v2) = scfa_list

for (i in seq_len(scfa_len - 1)) {
  for (j in seq(i + 1, scfa_len)) {
    scfa1 = scfa_list[i]
    scfa2 = scfa_list[j]
    co_form = as.formula(paste0("~", scfa1, "+", scfa2, "|", scfa1, "+", scfa2))
    res_indep = cocor(formula = co_form, data = df_v2_list)
    mat_p_v2[i, j] = res_indep@fisher1925$p.value
  }
}

diag(mat_p_v2) = 1
mat_p_v2[lower.tri(mat_p_v2)] = t(mat_p_v2)[lower.tri(mat_p_v2)]
df_p_v2 = as.data.frame(mat_p_v2) %>%
  rownames_to_column("var1") %>%
  pivot_longer(cols = -var1, names_to = "var2", values_to = "pvalue")

# visit 1 vs. visit 2 within No
df_no_v1 = df_no %>%
  filter(visit == "20wks") %>%
  dplyr::select(Study_ID, any_of(scfa_list))

df_no_v2 = df_no %>%
  filter(visit == "28wks") %>%
  dplyr::select(Study_ID, any_of(scfa_list))

df_no_wide = df_no_v1 %>%
  inner_join(df_no_v2, by = "Study_ID", suffix = c("_v1", "_v2"))

mat_p_no = matrix(NA, nrow = scfa_len, ncol = scfa_len)
colnames(mat_p_no) = scfa_list
rownames(mat_p_no) = scfa_list

for (i in seq_len(scfa_len - 1)) {
  for (j in seq(i + 1, scfa_len)) {
    scfa1 = scfa_list[i]
    scfa2 = scfa_list[j]
    co_form = as.formula(paste0("~", scfa1, "_v1+", scfa2, "_v1|", 
                                scfa1, "_v2+", scfa2, "_v2"))
    res_dep_nonoverlap = cocor(formula = co_form, data = df_no_wide)
    mat_p_no[i, j] = res_dep_nonoverlap@steiger1980$p.value
  }
}

diag(mat_p_no) = 1
mat_p_no[lower.tri(mat_p_no)] = t(mat_p_no)[lower.tri(mat_p_no)]
df_p_no = as.data.frame(mat_p_no) %>%
  rownames_to_column("var1") %>%
  pivot_longer(cols = -var1, names_to = "var2", values_to = "pvalue")

# visit 1 vs. visit 2 within Yes
df_yes_v1 = df_yes %>%
  filter(visit == "20wks") %>%
  dplyr::select(Study_ID, any_of(scfa_list))

df_yes_v2 = df_yes %>%
  filter(visit == "28wks") %>%
  dplyr::select(Study_ID, any_of(scfa_list))

df_yes_wide = df_yes_v1 %>%
  inner_join(df_yes_v2, by = "Study_ID", suffix = c("_v1", "_v2"))

mat_p_yes = matrix(NA, nrow = scfa_len, ncol = scfa_len)
colnames(mat_p_yes) = scfa_list
rownames(mat_p_yes) = scfa_list

for (i in seq_len(scfa_len - 1)) {
  for (j in seq(i + 1, scfa_len)) {
    scfa1 = scfa_list[i]
    scfa2 = scfa_list[j]
    co_form = as.formula(paste0("~", scfa1, "_v1+", scfa2, "_v1|", 
                                scfa1, "_v2+", scfa2, "_v2"))
    res_dep_yesyesverlap = cocor(formula = co_form, data = df_yes_wide)
    mat_p_yes[i, j] = res_dep_yesyesverlap@steiger1980$p.value
  }
}

diag(mat_p_yes) = 1
mat_p_yes[lower.tri(mat_p_yes)] = t(mat_p_yes)[lower.tri(mat_p_yes)]
df_p_yes = as.data.frame(mat_p_yes) %>%
  rownames_to_column("var1") %>%
  pivot_longer(cols = -var1, names_to = "var2", values_to = "pvalue")
```

### Visualization

```{r}
# Visit 1, No
df_p_v1_no = df_p_v1 %>%
  transmute(var1, var2, p_by_group = pvalue) %>%
  left_join(df_p_no %>%
              transmute(var1, var2, p_by_visit = pvalue),
            by = c("var1", "var2")) %>%
  dplyr::mutate(p_ind = case_when(
    p_by_group < 0.05 & p_by_visit > 0.05 ~ "1",
    p_by_group > 0.05 & p_by_visit < 0.05 ~ "2",
    p_by_group < 0.05 & p_by_visit < 0.05 ~ "3",
    TRUE ~ "0"
  ))

df_fig_v1_no = df_corr_v1_no %>%
  left_join(df_p_v1_no, by = c("var1", "var2"))

p_heat_v1_no = df_fig_v1_no %>%
  ggplot(aes(x = var1, y = var2, fill = value)) +
  geom_tile(color = "black") +
  geom_text(
    aes(
      label = round(value, 2),
      fontface = ifelse(p_ind == 0, "plain", "bold"),
      color = p_ind)) +
  scale_color_manual(values = c("grey80", "chartreuse3", "blue", "red")) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0,
                       name = NULL) +
  labs(x = NULL, y = NULL, title = "Visit 1, Control") +
  theme_minimal() +
  guides(color = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5))

# Visit 1, Yes
df_p_v1_yes = df_p_v1 %>%
  transmute(var1, var2, p_by_group = pvalue) %>%
  left_join(df_p_yes %>%
              transmute(var1, var2, p_by_visit = pvalue),
            by = c("var1", "var2")) %>%
  dplyr::mutate(p_ind = case_when(
    p_by_group < 0.05 & p_by_visit > 0.05 ~ "1",
    p_by_group > 0.05 & p_by_visit < 0.05 ~ "2",
    p_by_group < 0.05 & p_by_visit < 0.05 ~ "3",
    TRUE ~ "0"
  ))
df_p_v1_yes$p_ind = factor(df_p_v1_yes$p_ind, levels = c("0", "1", "2", "3"))
df_fig_v1_yes = df_corr_v1_yes %>%
  left_join(df_p_v1_yes, by = c("var1", "var2"))

p_heat_v1_yes = df_fig_v1_yes %>%
  ggplot(aes(x = var1, y = var2, fill = value)) +
  geom_tile(color = "black") +
  geom_text(
    aes(
      label = round(value, 2),
      fontface = ifelse(p_ind == 0, "plain", "bold"),
      color = p_ind)) +
  scale_color_manual(values = c("grey80", "chartreuse3", "blue", "red")) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0,
                       name = NULL) +
  labs(x = NULL, y = NULL, title = "Visit 1, Case") +
  theme_minimal() +
  guides(color = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5))

# Visit 2, No
df_p_v2_no = df_p_v2 %>%
  transmute(var1, var2, p_by_group = pvalue) %>%
  left_join(df_p_no %>%
              transmute(var1, var2, p_by_visit = pvalue),
            by = c("var1", "var2")) %>%
  dplyr::mutate(p_ind = case_when(
    p_by_group < 0.05 & p_by_visit > 0.05 ~ "1",
    p_by_group > 0.05 & p_by_visit < 0.05 ~ "2",
    p_by_group < 0.05 & p_by_visit < 0.05 ~ "3",
    TRUE ~ "0"
  ))

df_fig_v2_no = df_corr_v2_no %>%
  left_join(df_p_v2_no, by = c("var1", "var2"))

p_heat_v2_no = df_fig_v2_no %>%
  ggplot(aes(x = var1, y = var2, fill = value)) +
  geom_tile(color = "black") +
  geom_text(
    aes(
      label = round(value, 2),
      fontface = ifelse(p_ind == 0, "plain", "bold"),
      color = p_ind)) +
  scale_color_manual(values = c("grey80", "chartreuse3", "blue", "red")) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0,
                       name = NULL) +
  labs(x = NULL, y = NULL, title = "Visit 2, Control") +
  theme_minimal() +
  guides(color = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5))

# Visit 2, Yes
df_p_v2_yes = df_p_v2 %>%
  transmute(var1, var2, p_by_group = pvalue) %>%
  left_join(df_p_yes %>%
              transmute(var1, var2, p_by_visit = pvalue),
            by = c("var1", "var2")) %>%
  dplyr::mutate(p_ind = case_when(
    p_by_group < 0.05 & p_by_visit > 0.05 ~ "1",
    p_by_group > 0.05 & p_by_visit < 0.05 ~ "2",
    p_by_group < 0.05 & p_by_visit < 0.05 ~ "3",
    TRUE ~ "0"
  ))
df_p_v2_yes$p_ind = factor(df_p_v2_yes$p_ind, levels = c("0", "1", "2", "3"))
df_fig_v2_yes = df_corr_v2_yes %>%
  left_join(df_p_v2_yes, by = c("var1", "var2"))

p_heat_v2_yes = df_fig_v2_yes %>%
  ggplot(aes(x = var1, y = var2, fill = value)) +
  geom_tile(color = "black") +
  geom_text(
    aes(
      label = round(value, 2),
      fontface = ifelse(p_ind == 0, "plain", "bold"),
      color = p_ind)) +
  scale_color_manual(values = c("grey80", "chartreuse3", "blue", "red")) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0,
                       name = NULL) +
  labs(x = NULL, y = NULL, title = "Visit 2, Case") +
  theme_minimal() +
  guides(color = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5))
```

### Outputs

```{r, fig.width=12, fig.height=10}
p_heat = ggarrange(p_heat_v1_no, p_heat_v1_yes,
                   p_heat_v2_no, p_heat_v2_yes,
                   common.legend = TRUE, legend = "right")
p_heat
ggsave("../results/figures/main_heatmap_ind.jpeg", width = 12, height = 10, dpi = 100)
ggsave("../results/figures/main_heatmap_ind.pdf", width = 12, height = 10)
```

## Correlation difference-in-differences

```{r, fig.width=12, fig.height=5}
# Estimates
corr_diff_no = corr_v2_no - corr_v1_no
corr_diff_yes = corr_v2_yes - corr_v1_yes
corr_did = corr_diff_no - corr_diff_yes

# P-values
scfa_list = c("Acetic", "Propionic", "Isobutyric", 
              "Butyric","Isovaleric", "Valeric")
perm_num = 1000
corr_did_list = vector("list", length = perm_num)
for (i in seq_len(perm_num)) {
  set.seed(i)
  df_permute = df_merge
  df_permute$wheezing = sample(df_permute$wheezing, size = nrow(df_permute))
  
  df_scfa_v1 = df_permute %>%
    dplyr::filter(visit == "20wks") %>%
    dplyr::select(wheezing, any_of(scfa_list))
  df_scfa_v2 = df_permute %>%
    dplyr::filter(visit == "28wks") %>%
    dplyr::select(wheezing, any_of(scfa_list))
  
  # No
  corr_v1_no = cor(df_scfa_v1 %>%
                     filter(wheezing == "No") %>%
                     dplyr::select(-wheezing)) 
  corr_v1_no[is.na(corr_v1_no)] = 0
  
  corr_v2_no = cor(df_scfa_v2 %>%
                     filter(wheezing == "No") %>%
                     dplyr::select(-wheezing)) 
  corr_v2_no[is.na(corr_v2_no)] = 0
  
  corr_diff_no_i = corr_v2_no - corr_v1_no
  
  # Yes
  corr_v1_yes = cor(df_scfa_v1 %>%
                      filter(wheezing == "Yes") %>%
                      dplyr::select(-wheezing)) 
  corr_v1_yes[is.na(corr_v1_yes)] = 0
  
  corr_v2_yes = cor(df_scfa_v2 %>%
                      filter(wheezing == "Yes") %>%
                      dplyr::select(-wheezing)) 
  corr_v2_yes[is.na(corr_v2_yes)] = 0
  
  corr_diff_yes_i = corr_v2_yes - corr_v1_yes
  
  corr_did_list[[i]] = corr_diff_no_i - corr_diff_yes_i
}

perm_p_list = lapply(corr_did_list, function(x)  x > abs(corr_did))
perm_p_1 = Reduce(`+`, perm_p_list) / length(perm_p_list)
perm_p = 2 * pmin(perm_p_1, 1 - perm_p_1)
df_p = as.data.frame(perm_p) %>%
  rownames_to_column("var1") %>%
  pivot_longer(cols = -var1, names_to = "var2", values_to = "pvalue")

# Visualization
# No
df_corr_diff_no = as.data.frame(corr_diff_no) %>%
  rownames_to_column("var1") %>%
  pivot_longer(cols = -var1, names_to = "var2", values_to = "value")
df_fig_diff_no = df_corr_diff_no %>%
  left_join(df_p, by = c("var1", "var2")) %>%
  dplyr::mutate(p_ind = ifelse(pvalue < 0.1 & value != 0, "1", "2"))

p_diff_no = df_fig_diff_no %>%
  ggplot(aes(x = var1, y = var2, fill = value)) +
  geom_tile(color = "black") +
  geom_text(
    aes(
      label = round(value, 2),
      fontface = ifelse(p_ind == "1", "bold", "plain"),
      color = p_ind)) +
  scale_color_manual(values = c("chartreuse3", "grey60")) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0,
                       name = NULL) +
  labs(x = NULL, y = NULL, title = "Correlation Differences: Control") +
  theme_minimal() +
  guides(color = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5))

# Yes
df_corr_diff_yes = as.data.frame(corr_diff_yes) %>%
  rownames_to_column("var1") %>%
  pivot_longer(cols = -var1, names_to = "var2", values_to = "value")
df_fig_diff_yes = df_corr_diff_yes %>%
  left_join(df_p, by = c("var1", "var2")) %>%
  dplyr::mutate(p_ind = ifelse(pvalue < 0.1 & value != 0, "1", "2"))

p_diff_yes = df_fig_diff_yes %>%
  ggplot(aes(x = var1, y = var2, fill = value)) +
  geom_tile(color = "black") +
  geom_text(
    aes(
      label = round(value, 2),
      fontface = ifelse(p_ind == "1", "bold", "plain"),
      color = p_ind)) +
  scale_color_manual(values = c("chartreuse3", "grey60")) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0,
                       name = NULL) +
  labs(x = NULL, y = NULL, title = "Correlation Differences: Case") +
  theme_minimal() +
  guides(color = FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5))

# Outputs
p_heat_did = ggarrange(p_diff_no, p_diff_yes, 
                       common.legend = TRUE, legend = "right")
p_heat_did
ggsave("../results/figures/main_heatmap_did.jpeg", width = 12, height = 5, dpi = 100)
ggsave("../results/figures/main_heatmap_did.pdf", width = 12, height = 5)
```

# Session information

```{r, message = FALSE, warning = FALSE, comment = NA}
sessionInfo()
```



